{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/vigne/Desktop/Community-Cart/frontend/src/pages/customer/verify-mobile.tsx"],"sourcesContent":["import { useRouter } from 'next/router';\r\nimport { useState, useEffect } from 'react';\r\nimport { useAuth } from '../../context/AuthContext';\r\n\r\nexport default function VerifyMobile() {\r\n    const router = useRouter();\r\n    const intent = router.query.intent as string; // 'signup' | 'google_signup_phone' | undefined\r\n    const { onboarding_step, get_route_for_step, loading, is_authenticated } = useAuth();\r\n\r\n    // Defaulting to empty string for precision, sanitized to snake_case\r\n    const [mobile_number, set_mobile_number] = useState('');\r\n    const [is_loading, set_is_loading] = useState(false);\r\n\r\n    // ROUTE GUARD: Enforce onboarding step requirements and session persistence\r\n    useEffect(() => {\r\n        if (!loading) {\r\n            // If the user loses their session during this step, send them to signin\r\n            if (!is_authenticated && (intent === 'signup' || intent === 'google_signup_phone')) {\r\n                router.replace('/customer/signin');\r\n                return;\r\n            }\r\n\r\n            // Only enforce onboarding guard for specific flows\r\n            if (intent === 'signup' || intent === 'google_signup_phone') {\r\n                const allowed_steps = ['EMAIL_VERIFIED', 'PHONE_PENDING'];\r\n\r\n                if (onboarding_step && !allowed_steps.includes(onboarding_step)) {\r\n                    // User is at wrong step - redirect to correct route\r\n                    const correct_route = get_route_for_step(onboarding_step);\r\n                    if (router.pathname !== correct_route) {\r\n                        router.replace(correct_route);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }, [onboarding_step, intent, router, get_route_for_step, loading, is_authenticated]);\r\n\r\n    const handle_verify = async () => {\r\n        if (mobile_number.length !== 10) {\r\n            alert('Please enter a valid 10-digit mobile number');\r\n            return;\r\n        }\r\n\r\n        set_is_loading(true);\r\n        try {\r\n            // Get email from query params or appropriate session storage\r\n            let email = router.query.email as string;\r\n\r\n            if (!email) {\r\n                const isGoogle = intent?.includes('google');\r\n                const key = isGoogle ? 'cc_google_signup_temp' : 'cc_signup_temp';\r\n                const stored = JSON.parse(sessionStorage.getItem(key) || '{}');\r\n                email = stored.email;\r\n\r\n                // Fallback for Google flow\r\n                if (!email && isGoogle) {\r\n                    const storedManual = JSON.parse(sessionStorage.getItem('cc_signup_temp') || '{}');\r\n                    email = storedManual.email;\r\n                }\r\n            }\r\n\r\n            if (!email) {\r\n                throw new Error('Email not found. Please start signup again.');\r\n            }\r\n\r\n            // Call the add-mobile endpoint which sends OTP\r\n            const res = await fetch('http://localhost:5000/api/auth/customer/signup/add-mobile', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ email, mobile: mobile_number })\r\n            });\r\n\r\n            const data = await res.json();\r\n            if (!res.ok) {\r\n                throw new Error(data.message || 'Failed to send OTP');\r\n            }\r\n\r\n            // Navigate to OTP verification page\r\n            router.push({\r\n                pathname: '/customer/verify-otp',\r\n                query: {\r\n                    mobile: mobile_number,\r\n                    email,\r\n                    intent: intent === 'signup_phone' ? 'signup_phone' : 'google_signup_phone'\r\n                }\r\n            });\r\n        } catch (err: any) {\r\n            console.error('Send Mobile OTP Error:', err);\r\n            alert(err.message);\r\n        } finally {\r\n            set_is_loading(false);\r\n        }\r\n    };\r\n\r\n    // Prevent rendering while the AuthContext is still verifying the session\r\n    if (loading) {\r\n        return (\r\n            <div style={{ height: '100vh', display: 'flex', justifyContent: 'center', alignItems: 'center' }}>\r\n                <p>Checking session...</p>\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className=\"verify-mobile-page\">\r\n            <header className=\"vm-header\">\r\n                <button className=\"vm-back-button\" onClick={() => router.back()}>\r\n                    <svg\r\n                        className=\"vm-back-icon\"\r\n                        fill=\"none\"\r\n                        stroke=\"currentColor\"\r\n                        viewBox=\"0 0 24 24\"\r\n                        xmlns=\"http://www.w3.org/2000/svg\"\r\n                    >\r\n                        <path\r\n                            strokeLinecap=\"round\"\r\n                            strokeLinejoin=\"round\"\r\n                            strokeWidth={2.5}\r\n                            d=\"M15 19l-7-7 7-7\"\r\n                        />\r\n                    </svg>\r\n                </button>\r\n                <h1 className=\"vm-title\">Verify Mobile</h1>\r\n            </header>\r\n\r\n            <p className=\"vm-subtitle\">\r\n                Please enter your mobile number. You'll receive a One-Time-Password.\r\n            </p>\r\n\r\n            <div className=\"vm-content\">\r\n                <div className=\"vm-input-group\">\r\n                    <div className=\"vm-input-field\">\r\n                        <label className=\"vm-input-label\">Phone no.</label>\r\n\r\n                        <div className=\"vm-prefix-container\">\r\n                            <span className=\"vm-prefix\">+91</span>\r\n                            <div className=\"vm-divider\"></div>\r\n                        </div>\r\n\r\n                        <input\r\n                            type=\"tel\"\r\n                            className=\"vm-phone-input\"\r\n                            value={mobile_number}\r\n                            onChange={(e) => set_mobile_number(e.target.value.replace(/\\D/g, ''))}\r\n                            maxLength={10}\r\n                            placeholder=\"Enter 10 digit number\"\r\n                        />\r\n\r\n                        {mobile_number.length === 10 && (\r\n                            <img\r\n                                src=\"/customer/assets/icons/check.svg\"\r\n                                alt=\"verified\"\r\n                                className=\"vm-input-icon-right\"\r\n                            />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <button className=\"vm-verify-button\" onClick={handle_verify} disabled={is_loading}>\r\n                    {is_loading ? 'Sending...' : 'Send / Verify'}\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n}"],"names":[],"mappings":"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"}}]
}