{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/vigne/Desktop/Community-Cart/frontend/src/pages/customer/verify-otp.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useRouter } from 'next/router';\r\nimport { useEffect, useRef, useState } from 'react';\r\nimport { useAuth } from '../../context/AuthContext';\r\n\r\nexport default function VerifyOtp() {\r\n    const router = useRouter();\r\n    const { sign_in } = useAuth();\r\n    const { intent, email = '' } = router.query as {\r\n        intent?: string;\r\n        email?: string;\r\n    };\r\n\r\n    const [otp, setOtp] = useState<string[]>(Array(6).fill(''));\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState('');\r\n    const [timer, setTimer] = useState(30);\r\n    const [resendDisabled, setResendDisabled] = useState(true);\r\n\r\n    const inputRefs = useRef<(HTMLInputElement | null)[]>([]);\r\n\r\n    useEffect(() => {\r\n        inputRefs.current[0]?.focus();\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        let interval: NodeJS.Timeout;\r\n        if (timer > 0) {\r\n            interval = setInterval(() => {\r\n                setTimer((prev) => prev - 1);\r\n            }, 1000);\r\n        } else {\r\n            setResendDisabled(false);\r\n        }\r\n        return () => clearInterval(interval);\r\n    }, [timer]);\r\n\r\n    const handleChange = (val: string, idx: number) => {\r\n        if (!/^\\d?$/.test(val)) return;\r\n        const copy = [...otp];\r\n        copy[idx] = val;\r\n        setOtp(copy);\r\n        if (val && idx < 5) inputRefs.current[idx + 1]?.focus();\r\n    };\r\n\r\n    const handleResend = async () => {\r\n        if (resendDisabled) return;\r\n        setLoading(true);\r\n        setError('');\r\n\r\n        try {\r\n            const res = await fetch(\r\n                'http://localhost:5000/api/auth/customer/signup/resend-otp',\r\n                {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({ email }),\r\n                }\r\n            );\r\n\r\n            const data = await res.json();\r\n            if (!res.ok) throw new Error(data.message || 'Resend failed');\r\n\r\n            setTimer(30);\r\n            setResendDisabled(true);\r\n            setOtp(Array(6).fill(''));\r\n            inputRefs.current[0]?.focus();\r\n            alert(`OTP Resent! Attempts remaining: ${data.attemptsRemaining}`);\r\n\r\n        } catch (err: any) {\r\n            setError(err.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handlePaste = (e: React.ClipboardEvent<HTMLInputElement>) => {\r\n        e.preventDefault();\r\n        const pasted = e.clipboardData.getData('text').replace(/\\D/g, '');\r\n        if (!pasted) return;\r\n\r\n        const digits = pasted.slice(0, 6).split('');\r\n        const newOtp = [...otp];\r\n\r\n        digits.forEach((d, i) => {\r\n            newOtp[i] = d;\r\n        });\r\n\r\n        setOtp(newOtp);\r\n\r\n        const lastIndex = Math.min(digits.length, 6) - 1;\r\n        inputRefs.current[lastIndex]?.focus();\r\n    };\r\n\r\n    const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>, index: number) => {\r\n        if (e.key === 'Backspace') {\r\n            if (otp[index]) {\r\n                const newOtp = [...otp];\r\n                newOtp[index] = '';\r\n                setOtp(newOtp);\r\n            } else if (index > 0) {\r\n                inputRefs.current[index - 1]?.focus();\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleVerify = async () => {\r\n        const otpValue = otp.join('');\r\n        if (otpValue.length !== 6) {\r\n            setError('Enter 6-digit OTP');\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        setError('');\r\n\r\n        try {\r\n            // Determine endpoint based on intent\r\n            let endpoint = '';\r\n            if (intent === 'manual_signup') {\r\n                endpoint = 'http://localhost:5000/api/auth/customer/signup/verify-email';\r\n            } else if (intent === 'google_signup') {\r\n                endpoint = 'http://localhost:5000/api/auth/customer/google/signup/verify-email';\r\n            } else {\r\n                throw new Error('Invalid signup intent. Please restart signup.');\r\n            }\r\n\r\n            if (!email) throw new Error('Email missing. Restart signup.');\r\n\r\n            const res = await fetch(endpoint, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({ email, otp: otpValue }),\r\n            });\r\n\r\n            const data = await res.json();\r\n            if (!res.ok) throw new Error(data.message || 'OTP verification failed');\r\n\r\n            // Update AuthContext state immediately\r\n            if (data.auth_token && data.user) {\r\n                sign_in(data.user, data.auth_token);\r\n            }\r\n\r\n            // Navigate to home\r\n            router.push('/customer/home');\r\n\r\n        } catch (err: any) {\r\n            setError(err.message);\r\n            setOtp(Array(6).fill(''));\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"otp-page\">\r\n            <div className=\"otp-header\">\r\n                <button className=\"otp-back-button\" onClick={() => router.back()}>\r\n                    <img\r\n                        src=\"/customer/assets/icons/backward.svg\"\r\n                        alt=\"back\"\r\n                        className=\"otp-back-icon\"\r\n                    />\r\n                </button>\r\n            </div>\r\n\r\n            <div className=\"otp-content\">\r\n                <p className=\"otp-instruction\">\r\n                    Enter the 6-digit code sent to your\r\n                    <br />\r\n                    {email}\r\n                </p>\r\n\r\n                {error && <p style={{ color: 'red', marginBottom: 16 }}>{error}</p>}\r\n\r\n                <div className=\"otp-inputs-container\">\r\n                    {otp.map((d, i) => (\r\n                        <input\r\n                            key={i}\r\n                            onPaste={handlePaste}\r\n                            onKeyDown={(e) => handleKeyDown(e, i)}\r\n                            className={`otp-digit-input ${d ? 'filled' : ''}`}\r\n                            maxLength={1}\r\n                            value={d}\r\n                            onChange={(e) => handleChange(e.target.value, i)}\r\n                            ref={(el) => {\r\n                                inputRefs.current[i] = el;\r\n                            }}\r\n                        />\r\n                    ))}\r\n                </div>\r\n\r\n                <div className=\"otp-resend\">\r\n                    Didn't receive code?\r\n                    <button\r\n                        className=\"otp-resend-link\"\r\n                        onClick={handleResend}\r\n                        disabled={resendDisabled}\r\n                        style={{\r\n                            opacity: resendDisabled ? 0.5 : 1,\r\n                            cursor: resendDisabled ? 'not-allowed' : 'pointer',\r\n                        }}\r\n                    >\r\n                        Resend {timer > 0 ? `(${timer}s)` : ''}\r\n                    </button>\r\n                </div>\r\n\r\n                <button\r\n                    className=\"otp-verify-button\"\r\n                    onClick={handleVerify}\r\n                    disabled={loading}\r\n                >\r\n                    {loading ? 'Verifying...' : 'Verify'}\r\n                </button>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}